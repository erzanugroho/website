<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi Prediksi - HASTMA CUP 2026</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0f1d 0%, #151b2e 100%);
            min-height: 100vh;
            font-family: 'Outfit', 'Lexend', sans-serif;
        }
        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .prediction-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        .prediction-correct {
            border-left: 3px solid #22c55e;
        }
        .prediction-wrong {
            border-left: 3px solid #ef4444;
        }
        .prediction-pending {
            border-left: 3px solid #eab308;
        }
        .status-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        .status-success { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-waiting { background: rgba(234, 179, 8, 0.2); color: #eab308; }
    </style>
</head>
<body class="text-white">
    <div class="container max-w-md mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <img src="logo.png" alt="HASTMA CUP" class="h-20 mx-auto mb-4">
            <h1 class="text-2xl font-bold">VERIFIKASI PREDIKSI</h1>
            <p class="text-gray-400 text-sm">HASTMA CUP 2026 - Pick'em Challenge</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="animate-spin w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-400">Memverifikasi prediksi...</p>
        </div>

        <!-- Result State -->
        <div id="resultState" class="hidden">
            <!-- Status Header -->
            <div class="status-card p-6 mb-6 text-center" id="statusHeader">
                <div id="statusIcon" class="status-icon">
                    <span class="material-symbols-outlined text-4xl">hourglass_top</span>
                </div>
                <h2 id="statusTitle" class="text-xl font-bold mb-2">Menunggu...</h2>
                <p id="statusDesc" class="text-gray-400 text-sm">Sedang memeriksa hasil prediksi</p>
            </div>

            <!-- Predictor Info -->
            <div class="status-card p-4 mb-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Nama Prediktor</div>
                <div id="predictorName" class="text-lg font-bold">-</div>
            </div>

            <!-- Predictions Detail -->
            <div class="status-card p-4 mb-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Detail Prediksi</div>
                
                <div id="predictionsList">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Score Summary -->
            <div id="scoreSummary" class="status-card p-4 mb-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400">Skor Prediksi</span>
                    <span id="scoreText" class="text-2xl font-bold text-yellow-400">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">Akurasi</span>
                    <span id="percentageText" class="text-lg font-bold text-white">-</span>
                </div>
                <div style="margin-top: 12px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                    <div id="percentageBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #eab308, #f59e0b); border-radius: 4px; transition: width 0.8s ease;"></div>
                </div>
            </div>

            <!-- Back Button -->
            <a href="index.html" class="block w-full py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-slate-900 font-bold rounded-xl text-center">
                Kembali ke Beranda
            </a>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-4xl text-red-500">error</span>
            </div>
            <h2 class="text-xl font-bold mb-2 text-red-400">Kode Tidak Valid</h2>
            <p class="text-gray-400 mb-6">QR code atau hash yang Anda masukkan tidak dapat didecode.</p>
            <a href="pickem.html" class="inline-block px-6 py-3 bg-slate-700 text-white rounded-xl">
                Kembali
            </a>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script>
        // Get current tournament data
        function getTournamentData() {
            const local = localStorage.getItem('hastmaCupData');
            if (local) {
                try {
                    const data = JSON.parse(local);
                    console.log('Using data from localStorage');
                    return data;
                } catch (e) {
                    console.error('Error parsing local data:', e);
                }
            }
            console.log('Using DEFAULT_TOURNAMENT_DATA or empty');
            return window.DEFAULT_TOURNAMENT_DATA || { teams: [], matches: [] };
        }

        // Calculate group standings
        function calculateGroupStandings() {
            const data = getTournamentData();
            const teams = data.teams || [];
            const matches = data.matches || [];
            
            const standings = { A: { first: null, second: null }, B: { first: null, second: null } };
            const teamStats = {};
            
            teams.forEach(team => {
                teamStats[team.id] = { id: team.id, name: team.name, group: team.group, points: 0, gf: 0, ga: 0 };
            });
            
            matches.filter(m => m.stage === 'group' && m.status === 'finished').forEach(match => {
                const home = teamStats[match.homeTeam];
                const away = teamStats[match.awayTeam];
                if (!home || !away) return;
                
                home.gf += match.homeScore; home.ga += match.awayScore;
                away.gf += match.awayScore; away.ga += match.homeScore;
                
                if (match.homeScore > match.awayScore) home.points += 3;
                else if (match.homeScore < match.awayScore) away.points += 3;
                else { home.points += 1; away.points += 1; }
            });
            
            ['A', 'B'].forEach(group => {
                const groupTeams = Object.values(teamStats).filter(t => t.group === group);
                groupTeams.sort((a, b) => b.points - a.points || (b.gf - b.ga) - (a.gf - a.ga));
                if (groupTeams.length >= 2) {
                    standings[group].first = groupTeams[0].name;
                    standings[group].second = groupTeams[1].name;
                }
            });
            
            return standings;
        }

        // Get knockout winners
        function getKnockoutWinners() {
            const data = getTournamentData();
            const matches = data.matches || [];
            const teams = data.teams || [];
            const winners = { sf1: null, sf2: null, final: null, sf1finished: false, sf2finished: false, finalfinished: false };
            
            matches.forEach(match => {
                if (match.status !== 'finished') return;
                
                let winner = null;
                if (match.homeScore > match.awayScore) winner = match.homeTeam;
                else if (match.homeScore < match.awayScore) winner = match.awayTeam;
                
                if (!winner) return;
                
                const teamName = teams.find(t => t.id === winner)?.name || winner;
                
                if (match.id === 'SF1') { winners.sf1 = teamName; winners.sf1finished = true; }
                else if (match.id === 'SF2') { winners.sf2 = teamName; winners.sf2finished = true; }
                else if (match.id === 'F1') { winners.final = teamName; winners.finalfinished = true; }
            });
            
            return winners;
        }

        // Check tournament completion
        function checkTournamentStatus() {
            const data = getTournamentData();
            const matches = data.matches || [];
            
            const groupMatches = matches.filter(m => m.stage === 'group');
            const sfMatches = matches.filter(m => m.stage === 'semi');
            const finalMatch = matches.find(m => m.stage === 'final');
            
            return {
                groupFinished: groupMatches.every(m => m.status === 'finished'),
                sfFinished: sfMatches.every(m => m.status === 'finished'),
                finalFinished: finalMatch?.status === 'finished',
                totalMatches: matches.length,
                finishedMatches: matches.filter(m => m.status === 'finished').length
            };
        }

        // Verify prediction
        function verifyPrediction(code) {
            try {
                // Add padding if needed
                let encoded = code;
                while (encoded.length % 4 !== 0) encoded += '=';
                
                const decoded = atob(encoded);
                const parts = decoded.split('|');
                
                if (parts.length < 8) throw new Error('Invalid format');
                
                const name = parts[0];
                const predA1 = parts[1], predA2 = parts[2];
                const predB1 = parts[3], predB2 = parts[4];
                const predSF1 = parts[5], predSF2 = parts[6];
                const predWinner = parts[7];
                
                const standings = calculateGroupStandings();
                const koWinners = getKnockoutWinners();
                const status = checkTournamentStatus();
                
                // Check if tournament is still ongoing
                const isComplete = status.groupFinished && status.sfFinished && status.finalFinished;
                const hasAnyResult = status.finishedMatches > 0;
                
                if (!hasAnyResult) {
                    return {
                        status: 'waiting',
                        message: 'Turnamen belum dimulai',
                        name: name,
                        predictions: { predA1, predA2, predB1, predB2, predSF1, predSF2, predWinner },
                        actuals: {}
                    };
                }
                
                if (!isComplete) {
                    // Partial results
                    const results = [];
                    
                    if (standings.A.first) results.push({ label: 'Grup A 1st', pred: predA1, actual: standings.A.first, checked: true });
                    if (standings.A.second) results.push({ label: 'Grup A 2nd', pred: predA2, actual: standings.A.second, checked: true });
                    if (standings.B.first) results.push({ label: 'Grup B 1st', pred: predB1, actual: standings.B.first, checked: true });
                    if (standings.B.second) results.push({ label: 'Grup B 2nd', pred: predB2, actual: standings.B.second, checked: true });
                    if (koWinners.sf1finished) results.push({ label: 'SF1 Winner', pred: predSF1, actual: koWinners.sf1, checked: true });
                    if (koWinners.sf2finished) results.push({ label: 'SF2 Winner', pred: predSF2, actual: koWinners.sf2, checked: true });
                    if (koWinners.finalfinished) results.push({ label: 'Champion', pred: predWinner, actual: koWinners.final, checked: true });
                    
                    const pending = [];
                    if (!standings.A.first) pending.push('Grup A');
                    if (!standings.B.first) pending.push('Grup B');
                    if (!koWinners.sf1finished) pending.push('Semi Final 1');
                    if (!koWinners.sf2finished) pending.push('Semi Final 2');
                    if (!koWinners.finalfinished) pending.push('Grand Final');
                    
                    return {
                        status: 'partial',
                        message: 'Menunggu hasil: ' + pending.join(', '),
                        name: name,
                        predictions: { predA1, predA2, predB1, predB2, predSF1, predSF2, predWinner },
                        actuals: { standings, koWinners },
                        results: results,
                        isComplete: false
                    };
                }
                
                // Complete results - check all
                const results = [
                    { label: 'Grup A 1st', pred: predA1, actual: standings.A.first, correct: predA1 === standings.A.first },
                    { label: 'Grup A 2nd', pred: predA2, actual: standings.A.second, correct: predA2 === standings.A.second },
                    { label: 'Grup B 1st', pred: predB1, actual: standings.B.first, correct: predB1 === standings.B.first },
                    { label: 'Grup B 2nd', pred: predB2, actual: standings.B.second, correct: predB2 === standings.B.second },
                    { label: 'SF1 Winner', pred: predSF1, actual: koWinners.sf1, correct: predSF1 === koWinners.sf1 },
                    { label: 'SF2 Winner', pred: predSF2, actual: koWinners.sf2, correct: predSF2 === koWinners.sf2 },
                    { label: 'Champion', pred: predWinner, actual: koWinners.final, correct: predWinner === koWinners.final }
                ];
                
                const correctCount = results.filter(r => r.correct).length;
                const allCorrect = correctCount === 7;
                
                return {
                    status: allCorrect ? 'success' : 'failed',
                    message: allCorrect ? 'Selamat! Semua prediksi benar!' : 'Ada prediksi yang tidak tepat',
                    name: name,
                    predictions: { predA1, predA2, predB1, predB2, predSF1, predSF2, predWinner },
                    actuals: { standings, koWinners },
                    results: results,
                    correctCount: correctCount,
                    totalCount: 7,
                    isComplete: true
                };
                
            } catch (e) {
                console.error(e);
                return { status: 'error', message: 'Kode tidak valid' };
            }
        }

        // Render result
        function renderResult(result) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultState').classList.remove('hidden');
            
            if (result.status === 'error') {
                document.getElementById('resultState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                return;
            }
            
            // Set name
            document.getElementById('predictorName').textContent = result.name;
            
            // Set status
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusDesc = document.getElementById('statusDesc');
            const statusHeader = document.getElementById('statusHeader');
            
            if (result.status === 'waiting') {
                statusIcon.className = 'status-icon status-waiting';
                statusIcon.innerHTML = '<span class="material-symbols-outlined text-4xl">schedule</span>';
                statusTitle.textContent = 'Menunggu Turnamen';
                statusTitle.className = 'text-xl font-bold mb-2 text-yellow-400';
                statusDesc.textContent = 'Turnamen HASTMA CUP 2026 belum dimulai. Silakan kembali setelah turnamen selesai.';
                statusHeader.className = 'status-card p-6 mb-6 text-center border-yellow-500/30';
            } else if (result.status === 'partial') {
                statusIcon.className = 'status-icon status-waiting';
                statusIcon.innerHTML = '<span class="material-symbols-outlined text-4xl">hourglass_top</span>';
                statusTitle.textContent = 'Menunggu Hasil';
                statusTitle.className = 'text-xl font-bold mb-2 text-yellow-400';
                statusDesc.textContent = result.message;
                statusHeader.className = 'status-card p-6 mb-6 text-center border-yellow-500/30';
            } else if (result.status === 'success') {
                statusIcon.className = 'status-icon status-success';
                statusIcon.innerHTML = '<span class="material-symbols-outlined text-4xl">check_circle</span>';
                statusTitle.textContent = 'üéâ Prediksi Benar!';
                statusTitle.className = 'text-xl font-bold mb-2 text-green-400';
                statusDesc.textContent = `Selamat ${result.name}! Semua prediksi Anda tepat. Anda berhak mendapatkan hadiah Rp 200.000!`;
                statusHeader.className = 'status-card p-6 mb-6 text-center border-green-500/30 bg-green-500/10';
            } else {
                statusIcon.className = 'status-icon status-error';
                statusIcon.innerHTML = '<span class="material-symbols-outlined text-4xl">cancel</span>';
                statusTitle.textContent = 'Prediksi Salah';
                statusTitle.className = 'text-xl font-bold mb-2 text-red-400';
                statusDesc.textContent = `Maaf ${result.name}, ada prediksi yang tidak tepat. Anda mendapatkan skor ${result.correctCount}/7.`;
                statusHeader.className = 'status-card p-6 mb-6 text-center border-red-500/30';
            }
            
            // Render predictions list
            const listEl = document.getElementById('predictionsList');
            listEl.innerHTML = '';
            
            // Build predictions array from result.predictions
            const preds = result.predictions || {};
            const predList = [
                { label: 'Grup A 1st', pred: preds.predA1 },
                { label: 'Grup A 2nd', pred: preds.predA2 },
                { label: 'Grup B 1st', pred: preds.predB1 },
                { label: 'Grup B 2nd', pred: preds.predB2 },
                { label: 'SF1 Winner', pred: preds.predSF1 },
                { label: 'SF2 Winner', pred: preds.predSF2 },
                { label: 'Champion', pred: preds.predWinner }
            ];
            
            // If we have results with actuals
            const resultsMap = {};
            if (result.results) {
                result.results.forEach(r => {
                    resultsMap[r.label] = r;
                });
            }
            
            predList.forEach(p => {
                const div = document.createElement('div');
                const resultItem = resultsMap[p.label];
                
                if (result.status === 'waiting') {
                    // No results yet, show prediction only
                    div.className = 'prediction-row prediction-pending';
                    div.innerHTML = `
                        <span class="text-gray-400">${p.label}</span>
                        <span class="font-bold text-yellow-400">${p.pred || '-'}</span>
                    `;
                } else if (result.status === 'partial' && resultItem) {
                    // Partial result available
                    const isCorrect = resultItem.pred === resultItem.actual;
                    div.className = `prediction-row ${isCorrect ? 'prediction-correct' : 'prediction-wrong'}`;
                    div.innerHTML = `
                        <div>
                            <div class="text-gray-400 text-xs">${p.label}</div>
                            <div class="font-bold">Prediksi: ${p.pred || '-'}</div>
                            ${resultItem.actual ? `<div class="text-sm ${isCorrect ? 'text-green-400' : 'text-red-400'}">Hasil: ${resultItem.actual}</div>` : ''}
                        </div>
                        ${resultItem.actual ? `<span class="material-symbols-outlined ${isCorrect ? 'text-green-400' : 'text-red-400'}">${isCorrect ? 'check_circle' : 'cancel'}</span>` : '<span class="text-yellow-400 text-sm">‚è≥</span>'}
                    `;
                } else if (result.isComplete && resultItem) {
                    // Complete results
                    const isCorrect = resultItem.correct;
                    div.className = `prediction-row ${isCorrect ? 'prediction-correct' : 'prediction-wrong'}`;
                    div.innerHTML = `
                        <div>
                            <div class="text-gray-400 text-xs">${p.label}</div>
                            <div class="font-bold">Prediksi: ${p.pred || '-'}</div>
                            <div class="text-sm ${isCorrect ? 'text-green-400' : 'text-red-400'}">Hasil: ${resultItem.actual || '-'}</div>
                        </div>
                        <span class="material-symbols-outlined ${isCorrect ? 'text-green-400' : 'text-red-400'}">${isCorrect ? 'check_circle' : 'cancel'}</span>
                    `;
                } else {
                    // Pending
                    div.className = 'prediction-row prediction-pending';
                    div.innerHTML = `
                        <span class="text-gray-400">${p.label}</span>
                        <span class="font-bold">${p.pred || '-'}</span>
                    `;
                }
                
                listEl.appendChild(div);
            });
            
            // Show score for partial and complete
            if ((result.status === 'partial' || result.isComplete) && result.results) {
                const scoreDiv = document.getElementById('scoreSummary');
                const scoreText = document.getElementById('scoreText');
                const percentageText = document.getElementById('percentageText');
                const percentageBar = document.getElementById('percentageBar');
                
                const correct = result.results.filter(r => {
                    if (result.status === 'partial') return r.pred === r.actual;
                    return r.correct;
                }).length;
                const total = result.results.length;
                const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
                
                scoreDiv.classList.remove('hidden');
                scoreText.textContent = `${correct}/${total}`;
                percentageText.textContent = `${percentage}%`;
                percentageText.className = `text-lg font-bold ${percentage >= 70 ? 'text-green-400' : percentage >= 40 ? 'text-yellow-400' : 'text-red-400'}`;
                
                // Animate progress bar
                setTimeout(() => {
                    percentageBar.style.width = `${percentage}%`;
                    percentageBar.style.background = percentage >= 70 
                        ? 'linear-gradient(90deg, #22c55e, #16a34a)' 
                        : percentage >= 40 
                            ? 'linear-gradient(90deg, #eab308, #f59e0b)' 
                            : 'linear-gradient(90deg, #ef4444, #dc2626)';
                }, 100);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (!code) {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                return;
            }
            
            // Wait for data.js to load
            if (!window.DEFAULT_TOURNAMENT_DATA) {
                console.log('Waiting for data.js...');
                setTimeout(() => {
                    const result = verifyPrediction(code);
                    renderResult(result);
                }, 500);
            } else {
                // Small delay for visual effect
                setTimeout(() => {
                    const result = verifyPrediction(code);
                    renderResult(result);
                }, 800);
            }
        });
    </script>
</body>
</html>
